v2ray_inbound_defaults:
  sniffing:
    enabled: "{{ sniffing_enabled }}"
    destOverride: [http, tls]

v2ray_inbounds:
  - port: 12345
    tag: tproxy
    protocol: dokodemo-door
    settings:
      followRedirect: true
      network: tcp,udp
    streamSettings:
      sockopt:
        tproxy: redirect

  - port: "{{ socks_port }}"
    tag: socks
    protocol: socks
    settings:
      auth: noauth
      udp: true

  - port: "{{ socks_direct_port }}"
    tag: socks-direct
    protocol: socks
    settings:
      auth: noauth
      udp: true

  - port: "{{ socks_forward_port }}"
    tag: socks-forward
    protocol: socks
    settings:
      auth: noauth
      udp: true

v2ray_outbound_direct:
  tag: "{{ v2ray_direct_outbound }}"
  protocol: freedom
  streamSettings:
    sockopt:
      mark: "{{ so_mark_direct }}"

v2ray_outbound_defaults:
  mux:
    enabled: "{{ (mux_concurrency | int) > 0 }}"
    concurrency: "{{ mux_concurrency }}"
  streamSettings:
    sockopt:
      tcpFastOpen: "{{ tcp_fast_open }}"
      mark: "{{ so_mark_forward }}"

v2ray_outbounds:
  vmess:
    protocol: vmess
    settings:
      vnext:
        - address: "{{ vm_server }}"
          port: "{{ vm_port }}"
          users:
            - id: "{{ vm_user_id }}"
              alter_id: "{{ vm_user_alter_id }}"
              security: "{{ vm_user_security }}"

  shadowsocks:
    protocol: shadowsocks
    settings:
      servers:
        - address: "{{ ss_server }}"
          port: "{{ ss_port }}"
          method: "{{ ss_method }}"
          password: "{{ ss_password }}"

v2ray_forward_outbound: "{{ forward_mode }}"
v2ray_direct_outbound: "direct"

v2ray_routes:
  - type: field
    inboundTag: [api]
    outboundTag: api

  - type: field
    inboundTag: [dns]
    outboundTag: '{{ v2ray_forward_outbound if dns_forwarding else v2ray_direct_outbound }}'

  - type: field
    inboundTag: [socks-direct]
    outboundTag: "{{ v2ray_direct_outbound }}"

  - type: field
    inboundTag: [socks-forward]
    outboundTag: "{{ v2ray_forward_outbound }}"

  - type: field
    source: "{{ direct_sources if direct_sources is not none else ['0.0.0.0'] }}"
    outboundTag: "{{ v2ray_direct_outbound }}"

  - type: field
    source: "{{ forward_sources if forward_sources is not none else ['0.0.0.0'] }}"
    outboundTag: "{{ v2ray_forward_outbound }}"

  - type: field
    ip: "{{ direct_dests if direct_dests is not none else ['0.0.0.0'] }}"
    outboundTag: "{{ v2ray_direct_outbound }}"

  - type: field
    ip: "{{ forward_dests if forward_dests is not none else ['0.0.0.0'] }}"
    outboundTag: "{{ v2ray_forward_outbound }}"

  - type: field
    outboundTag: "{{ v2ray_direct_outbound }}"
    domain: ["geosite:geolocation-cn"]

  - type: field
    outboundTag: "{{ v2ray_direct_outbound }}"
    ip: ["geoip:cn"]

v2ray_final_routes:
  - type: field
    outboundTag: "{{ v2ray_direct_outbound }}"
    protocol: bittorrent

  - type: field
    outboundTag: "{{ v2ray_forward_outbound }}"
    network: tcp,udp
